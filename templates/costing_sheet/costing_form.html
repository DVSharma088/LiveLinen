{% extends "base.html" %}
{% load static %}

{# External stylesheet (keep if you created costing-style.css) #}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'costing_sheet/costing-style.css' %}">
{% endblock %}

{% block title %}Create Costing Sheet | Live Linen{% endblock %}
{% block page_title %}Create Costing Sheet{% endblock %}

{% block content %}
<style>
  /* Enhanced, colorful styling for Create Costing Sheet */
  :root{
    --bg-1: #f6f8ff;
    --bg-2: #fbfdff;
    --card: #ffffff;
    --muted: #64748b;
    --accent: #5b21b6;      /* purple */
    --accent-2: #06b6d4;    /* teal */
    --accent-3: #10b981;    /* green */
    --soft-border: rgba(15,23,42,0.06);
    --radius: 12px;
  }

  body { background: linear-gradient(180deg,var(--bg-1), #ffffff); }

  .costing-wrap {
    max-width: 1200px; margin:28px auto; padding:18px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:#0f172a;
  }

  /* Hero */
  .hero {
    display:flex; justify-content:space-between; align-items:center; gap:14px;
    padding:18px; border-radius:14px;
    background: linear-gradient(90deg, rgba(91,33,182,0.09), rgba(6,182,212,0.04));
    border: 1px solid var(--soft-border);
    box-shadow: 0 14px 40px rgba(91,33,182,0.06);
    margin-bottom:18px;
  }
  .hero h4 { margin:0; font-weight:800; letter-spacing:-0.3px; color:var(--accent); font-size:1.15rem; }
  .hero .sub { color:var(--muted); font-size:0.95rem; }

  /* Layout: single column (removed right summary) */
  .stack { display:flex; flex-direction:column; gap:16px; }

  /* Box card with colored header accent */
  .box-card {
    background: linear-gradient(180deg, var(--card), rgba(250,250,255,0.95));
    border-radius: var(--radius);
    padding:14px;
    border: 1px solid var(--soft-border);
    box-shadow: 0 12px 30px rgba(11,20,40,0.04);
    transition: transform 160ms ease, box-shadow 160ms ease;
  }
  .box-card:hover { transform: translateY(-6px); box-shadow: 0 28px 60px rgba(11,20,40,0.06); }

  .box-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:8px; }
  .box-title h6 { margin:0; font-weight:700; color:var(--accent); font-size:1rem; display:flex; align-items:center; gap:8px; }
  .box-title h6::before {
    content: "";
    display:inline-block; width:10px; height:10px; border-radius:3px;
    background: linear-gradient(180deg,var(--accent),var(--accent-2));
    box-shadow: 0 6px 18px rgba(91,33,182,0.14);
  }
  .box-title .hint { font-size:0.88rem; color:var(--muted); }

  /* Forms */
  .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .three-col { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
  .full-row { display:block; }
  .form-label { font-size:0.88rem; font-weight:700; margin-bottom:6px; color:#0f172a; display:block; }
  .small-note { font-size:0.85rem; color:var(--muted); }

  .form-control, .form-select {
    padding:10px 12px; border-radius:10px; border:1px solid var(--soft-border);
    background: linear-gradient(180deg,#fff,#fbfdff); font-size:0.95rem; width:100%; box-sizing:border-box;
  }
  .form-control:focus, .form-select:focus { outline:none; box-shadow: 0 10px 28px rgba(91,33,182,0.06); border-color: rgba(91,33,182,0.6); transform: translateY(-1px); }
  .form-control[readonly] { background:#f0f7f6; color:#123; }

  /* Color chips - more vivid */
  .colors-grid {
    display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:10px; margin-top:8px;
  }
  .color-chip {
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:10px 12px; border-radius:10px; cursor:pointer;
    background: linear-gradient(180deg,#fff,#fbfdff);
    border: 1px solid rgba(91,33,182,0.06);
    transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
  }
  .color-chip:hover { transform: translateY(-4px); box-shadow: 0 14px 38px rgba(6,182,212,0.06); border-color: rgba(6,182,212,0.12); }
  .color-label { display:flex; align-items:center; gap:0.75rem; }
  .color-swatch { width:28px; height:20px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); box-shadow: inset 0 -6px 14px rgba(0,0,0,0.03); }
  .color-chip input[type="checkbox"] { transform:scale(1.05); margin-right:8px; accent-color: var(--accent); }

  /* SKU preview: bright accent border */
  .sku-preview { margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(91,33,182,0.09);
    background: linear-gradient(180deg, rgba(91,33,182,0.02), rgba(6,182,212,0.01)); }
  .sku-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
  .sku-item {
    display:flex; justify-content:space-between; gap:12px; align-items:center; padding:10px 12px; border-radius:10px;
    background: linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(6,182,212,0.06);
    box-shadow: 0 8px 22px rgba(6,182,212,0.03);
  }
  .sku-item strong { color: #062; font-weight:700; }
  .sku-code { font-family: ui-monospace, SFMono-Regular, Menlo, "Roboto Mono", monospace; font-weight:800; color:var(--accent); }

  /* Buttons */
  .btn {
    display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:10px; font-weight:700;
    border: none; cursor:pointer; color:white;
    background: linear-gradient(90deg, var(--accent), #7c3aed);
    box-shadow: 0 10px 28px rgba(91,33,182,0.12);
  }
  .btn-outline {
    background: linear-gradient(180deg,#fff,#fbfdff); color:var(--accent);
    border: 1px solid rgba(91,33,182,0.08);
    box-shadow: 0 6px 20px rgba(6,182,212,0.03);
  }
  .btn-ghost { background:transparent; color:var(--accent-2); border:1px dashed rgba(6,182,212,0.08); }

  /* Accessory group */
  .accessory-qty-group { display:flex; gap:8px; align-items:center; }
  .accessory-qty-group .form-control { width:90px; text-align:center; }

  .form-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:6px; }

  /* Subtle footer hint */
  .page-foot-hint { margin-top:8px; font-size:0.88rem; color:var(--muted); text-align:center; }

  @media (max-width:980px){
    .two-col, .three-col { grid-template-columns: 1fr; }
  }
</style>

<div class="costing-wrap">
  <div class="hero" role="banner" aria-label="Create costing sheet">
    <div>
      <h4>Create Costing Sheet</h4>
      <div class="sub">Inputs first → Dropdowns → Colors → SKUs → Accessory → Remaining fields (reordered & styled)</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <a class="btn btn-outline" href="{% url 'costing_sheet:list' %}">Back to list</a>
      <a class="btn" href="javascript:void(0)" onclick="document.getElementById('costing-form').reportValidity();">Preview</a>
    </div>
  </div>

  <form method="post" id="costing-form" novalidate>
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="box-card" style="border-left:4px solid #f43f5e;">
        <div class="small-note" style="padding:10px;color:#b91c1c;">{{ form.non_field_errors }}</div>
      </div>
    {% endif %}

    <div class="stack">
      <!-- 1) Manual text fields box -->
      <div class="box-card" id="box-manual-texts">
        <div class="box-title">
          <h6>Manual Inputs — Enter data</h6>
          <div class="hint">Free text / numeric fields</div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Name</label>
            {% if form.name %}
              {{ form.name }}<div class="invalid-feedback d-block">{{ form.name.errors }}</div>
            {% else %}
              <input id="id_name" name="name" class="form-control" placeholder="Enter name" value="{{ form.initial.name|default:'' }}">
            {% endif %}
          </div>

          <div>
            <label class="form-label">Collection</label>
            {% if form.collection %}
              {{ form.collection }}<div class="invalid-feedback d-block">{{ form.collection.errors }}</div>
            {% else %}
              <input id="id_collection" name="collection" class="form-control" value="{{ form.initial.collection|default:'' }}">
            {% endif %}
          </div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Width</label>
            {% if form.width %}{{ form.width }}<div class="invalid-feedback d-block">{{ form.width.errors }}</div>{% else %}<input id="id_width" name="width" class="form-control" step="0.01" min="0" value="0.00">{% endif %}
          </div>
          <div>
            <label class="form-label">Width UOM</label>
            {% if form.width_uom %}{{ form.width_uom }}<div class="invalid-feedback d-block">{{ form.width_uom.errors }}</div>{% else %}<input id="id_width_uom" name="width_uom" class="form-control" value="inch">{% endif %}
          </div>
        </div>

        <div class="two-col" style="margin-bottom:6px;">
          <div>
            <label class="form-label">Handwork (Optional)</label>
            {% if form.handwork %}{{ form.handwork }}<div class="invalid-feedback d-block">{{ form.handwork.errors }}</div>{% else %}<input id="id_handwork" name="handwork" class="form-control" value="{{ form.initial.handwork|default:'' }}">{% endif %}
          </div>
          <div>
            <label class="form-label">(Optional) Notes</label>
            <input id="id_shipping_notes" class="form-control" type="text" name="shipping_notes" value="">
          </div>
        </div>

        <div class="full-row" style="margin-top:8px;">
          <div class="small-note">These fields feed into SKU generation and pricing calculation.</div>
        </div>
      </div>

      <!-- 2) Dropdowns box -->
      <div class="box-card" id="box-dropdowns">
        <div class="box-title">
          <h6>Selectors — Dropdowns</h6>
          <div class="hint">Category, size, quality & accessory</div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Category</label>
            {% if form.category %}
              {{ form.category }}<div class="invalid-feedback d-block">{{ form.category.errors }}</div>
            {% else %}
              <select id="id_category_select" name="category" class="form-select" data-initial="{{ form.initial.category|default:'' }}">
                <option value="">-- select category --</option>
                {% if categories %}
                  {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            {% endif %}
          </div>

          <div>
            <label class="form-label">Category Master (Name)</label>
            {% if form.category_new %}{{ form.category_new }}<div class="invalid-feedback d-block">{{ form.category_new.errors }}</div>{% else %}
              <select id="id_category_master_new_select" name="category_new" class="form-select" data-initial="{{ form.initial.category_new|default:'' }}">
                <option value="">-- select category master --</option>
              </select>
            {% endif %}
          </div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Size</label>
            {% if form.size_master %}{{ form.size_master }}<div class="invalid-feedback d-block">{{ form.size_master.errors }}</div>{% else %}<select id="id_size_master_select" name="size_master" class="form-select"><option value="">-- select size --</option></select>{% endif %}
          </div>

          <div>
            <label class="form-label">Quality (Component)</label>
            {% if form.component_master %}{{ form.component_master }}<div class="invalid-feedback d-block">{{ form.component_master.errors }}</div>{% else %}
              <select id="id_component_master_select" name="component_master" class="form-select">
                <option value="">-- select quality --</option>
              </select>
            {% endif %}
          </div>
        </div>

        <div class="two-col" style="margin-bottom:6px;">
          <div>
            <label class="form-label">Accessory</label>
            {% if form.accessory %}
              <div>{{ form.accessory }}<div class="invalid-feedback d-block">{{ form.accessory.errors }}</div></div>
            {% else %}
              <select id="id_accessory_select" name="accessory" class="form-select"><option value="">-- select accessory --</option></select>
            {% endif %}
          </div>

          <div>
            <label class="form-label">Total basis</label>
            <select id="id_total_basis" name="total_basis" class="form-select">
              <option value="final_cost" selected>Final Cost</option>
              <option value="price_per_sqft">Price / sq.ft</option>
            </select>
          </div>
        </div>

        <div class="small-note">Dropdown selection controls color loading, SKU computation and accessory lookups.</div>
      </div>

      <!-- 3) Colors -->
      <div class="box-card" id="box-colors">
        <div class="box-title">
          <h6>Colors</h6>
          <div class="hint">Select one or more colors</div>
        </div>

        <div id="color-checkbox-container" class="colors-grid" aria-live="polite" role="region">
          <div class="small-note">Loading colors for selected quality (component)...</div>
        </div>

        <input type="hidden" id="id_colors" name="colors" value="{{ form.initial.colors|default:'' }}">
        <div class="small-note mt-2">Selected colors will generate separate SKU previews.</div>
      </div>

      <!-- 4) Generated SKUs -->
      <div class="box-card" id="box-skus">
        <div class="box-title">
          <h6>Generated SKUs</h6>
          <div class="hint">SKU previews and primary SKU (auto-filled)</div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Primary SKU (auto-filled)</label>
            {% if form.sku %}
              {{ form.sku }}<div class="invalid-feedback d-block">{{ form.sku.errors }}</div>
            {% else %}
              <input id="id_sku" name="sku" class="form-control" readonly placeholder="Auto-generated" value="{{ form.initial.sku|default:'' }}">
            {% endif %}
            <div class="small-note mt-1">Primary SKU used for single-color workflows.</div>
          </div>

          <div>
            <label class="form-label">How it's made</label>
            <div class="form-control" readonly>
              <span class="small-note"><strong>Cat</strong>(2 initials) + <strong>Col</strong>(2 initials) + <strong>Name</strong>(2nd word, 3 letters) + <strong>Clr</strong>(2 initials) + <strong>Size</strong></span>
            </div>
          </div>
        </div>

        <div class="sku-preview" id="sku-preview-box" aria-live="polite">
          <ul id="sku-list" class="sku-list"></ul>
        </div>
      </div>

      <!-- 5) Accessory -->
      <div class="box-card" id="box-accessory">
        <div class="box-title">
          <h6>Add Accessory</h6>
          <div class="hint">Accessory selection, qty and line total</div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Price / unit (INR)</label>
            <div class="input-group">
              <input id="id_accessory_unit_price_display" class="form-control" type="text" readonly value="0.00" aria-label="Accessory unit price">
              <input type="hidden" id="id_accessory_unit_price" name="accessory_unit_price" value="{{ form.initial.accessory_unit_price|default:'0.00' }}">
            </div>
            <div class="small-note mt-1">Unit price displayed from accessory lookup.</div>
          </div>

          <div>
            <label class="form-label">Stock available</label>
            <input id="id_accessory_stock_display" class="form-control" type="text" readonly value="0.000">
          </div>
        </div>

        <div class="two-col">
          <div>
            <label class="form-label">Quantity</label>
            <div class="accessory-qty-group">
              {% if form.accessory_quantity %}{{ form.accessory_quantity }}<div class="invalid-feedback d-block">{{ form.accessory_quantity.errors }}</div>{% else %}<input id="id_accessory_quantity" name="accessory_quantity" class="form-control" type="number" value="0" min="0" step="1">{% endif %}
              <button id="btn_add_accessory_qty" type="button" class="btn btn-outline">+</button>
            </div>
            <div class="small-note mt-1">Click + to increase quantity by 1.</div>
          </div>

          <div>
            <label class="form-label">Line Total (INR)</label>
            <input id="id_accessory_line_total_display" class="form-control" type="text" readonly value="0.00">
            <input type="hidden" id="id_accessory_line_total" name="accessory_line_total" value="{{ form.initial.accessory_line_total|default:'0.00' }}">
          </div>
        </div>
      </div>

      <!-- 6) Remaining pricing & shipping -->
      <div class="box-card" id="box-remaining">
        <div class="box-title">
          <h6>Pricing — Derived & Shipping</h6>
          <div class="hint">Computed fields and remaining inputs</div>
        </div>

        <div class="three-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Price / sq.ft</label>
            {% if form.price_per_sqft %}{{ form.price_per_sqft }}<div class="invalid-feedback d-block">{{ form.price_per_sqft.errors }}</div>{% else %}<input id="id_price_per_sqft" name="price_per_sqft" class="form-control" step="0.0001" min="0" value="0.0000">{% endif %}
          </div>
          <div>
            <label class="form-label">Final Cost</label>
            {% if form.final_cost %}{{ form.final_cost }}<div class="invalid-feedback d-block">{{ form.final_cost.errors }}</div>{% else %}<input id="id_final_cost" name="final_cost" class="form-control" step="0.01" min="0" value="0.00">{% endif %}
          </div>
          <div>
            <label class="form-label">Average</label>
            {% if form.average %}{{ form.average }}<div class="invalid-feedback d-block">{{ form.average.errors }}</div>{% else %}<input id="id_average" name="average" class="form-control" type="number" step="0.001" min="0" value="0.0000">{% endif %}
          </div>
        </div>

        <div class="two-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Total <span id="total_label_text" class="small-note">(Final Cost × Average)</span></label>
            {% if form.total %}{{ form.total }}{% else %}<input id="id_total" name="total" class="form-control" type="text" readonly value="0.0000">{% endif %}
          </div>
          <div>
            <label class="form-label">New Final Price <small class="small-note">(includes Stitching, Finishing, Packaging & Accessory)</small></label>
            {% if form.new_final_price %}{{ form.new_final_price }}{% else %}<input id="id_new_final_price" name="new_final_price" class="form-control" type="text" readonly value="0.0000">{% endif %}
          </div>
        </div>

        <div class="three-col" style="margin-bottom:12px;">
          <div>
            <label class="form-label">Shipping Cost India (INR)</label>
            {% if form.shipping_cost_india %}{{ form.shipping_cost_india }}<div class="invalid-feedback d-block">{{ form.shipping_cost_india.errors }}</div>{% else %}<input id="id_shipping_cost_india" name="shipping_cost_india" class="form-control" type="number" step="0.01" min="0" value="0.00">{% endif %}
          </div>
          <div>
            <label class="form-label">Shipping Cost US (USD)</label>
            {% if form.shipping_cost_us %}{{ form.shipping_cost_us }}<div class="invalid-feedback d-block">{{ form.shipping_cost_us.errors }}</div>{% else %}<input id="id_shipping_cost_us" name="shipping_cost_us" class="form-control" type="number" step="0.01" min="0" value="0.00">{% endif %}
          </div>
          <div>
            <label class="form-label">Shipping Cost Europe (EUR)</label>
            {% if form.shipping_cost_europe %}{{ form.shipping_cost_europe }}<div class="invalid-feedback d-block">{{ form.shipping_cost_europe.errors }}</div>{% else %}<input id="id_shipping_cost_europe" name="shipping_cost_europe" class="form-control" type="number" step="0.01" min="0" value="0.00">{% endif %}
          </div>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(91,33,182,0.06);margin:8px 0;" />

        <div class="three-col" style="gap:10px;">
          <div>
            <label class="form-label">GF Percent</label>
            <input id="id_gf_percent" name="gf_percent" class="form-control" value="{{ form.initial.gf_percent|default:'0' }}">
          </div>
          <div>
            <label class="form-label">Texas Buying %</label>
            <input id="id_texas_buying_percent" name="texas_buying_percent" class="form-control" value="{{ form.initial.texas_buying_percent|default:'0' }}">
          </div>
          <div>
            <label class="form-label">Texas Retail %</label>
            <input id="id_texas_retail_percent" name="texas_retail_percent" class="form-control" value="{{ form.initial.texas_retail_percent|default:'0' }}">
          </div>
        </div>

        <div class="two-col" style="margin-top:12px;">
          <div>
            <label class="form-label">US Buying Cost (USD)</label>
            <input id="id_us_buying_cost_usd" name="us_buying_cost_usd" class="form-control" readonly value="{{ form.initial.us_buying_cost_usd|default:'0.0000' }}">
          </div>
          <div>
            <label class="form-label">US Wholesale Cost</label>
            <input id="id_us_wholesale_cost" name="us_wholesale_cost" class="form-control" readonly value="{{ form.initial.us_wholesale_cost|default:'0.0000' }}">
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end;">
        <div class="form-actions">
          <button type="submit" class="btn">Save Costing Sheet</button>
          <a class="btn btn-outline" href="{% url 'costing_sheet:list' %}">Cancel</a>
        </div>
      </div>

      <div class="page-foot-hint">Tip: Select a quality to load colors. Select exactly one color to auto-fill Primary SKU.</div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Server-passed master data -->
<script id="costing-master" type="application/json">
{% if costing_master_json %}{{ costing_master_json|safe }}{% else %}{"categories":[],"sizes_by_category":{},"components":{}}{% endif %}
</script>

<script id="server-categories" type="application/json">{{ categories|safe }}</script>

<!-- Minimal config: existing AJAX endpoints + colors compatibility URL -->
<script id="costing-config" type="application/json">
{
  "ajax_category_details": "{% url 'costing_sheet:ajax_get_category_details' %}",
  "ajax_component_details": "{% url 'costing_sheet:ajax_get_component_details' %}",
  "ajax_accessories": "{% url 'costing_sheet:ajax_list_accessories' %}",
  "ajax_accessory_detail": "{% url 'costing_sheet:ajax_get_accessory_detail' pk=0 %}",
  "ajax_accessories_bulk": "{% url 'costing_sheet:ajax_accessories_bulk' %}",
  "ajax_compute_accessory_line": "{% url 'costing_sheet:ajax_compute_accessory_line' %}",
  "ajax_compute_sku": "{% url 'costing_sheet:ajax_compute_sku' %}",
  "components_colors_url": "{% url 'costing_sheet:colors_list_json' %}"
}
</script>

<!-- Reuse original JS logic (unchanged) -->
<script>
/* ========== Unified Color & SKU logic (with safe URL builder & robust fetch) ========== */
(function(){
  function parseJSON(id){
    try { var el = document.getElementById(id); if(!el) return null; return JSON.parse(el.textContent || el.innerText || "{}"); }
    catch(e){ return null; }
  }

  var cfg = parseJSON('costing-config') || {};
  var AJAX_COMPONENT_DETAILS = cfg.ajax_component_details;
  var AJAX_COMPUTE_SKU = cfg.ajax_compute_sku;
  var COMPONENTS_COLORS_URL = cfg.components_colors_url || null;

  var componentSelect = document.getElementById('id_component_master_select') || document.querySelector('select[name="component_master"]');
  var nameEl = document.getElementById('id_name');
  var collectionEl = document.getElementById('id_collection');
  var sizeSelect = document.getElementById('id_size_master_select');
  var colorContainer = document.getElementById('color-checkbox-container');
  var hiddenColors = document.getElementById('id_colors');
  var skuListEl = document.getElementById('sku-list');
  var primarySkuEl = document.getElementById('id_sku');
  var categorySelect = document.getElementById('id_category_select');
  var categoryNewSelect = document.getElementById('id_category_master_new_select');

  function readMaster(){
    try { return JSON.parse(document.getElementById('costing-master').textContent || "{}"); } catch(e){ return null; }
  }

  function buildUrl(base, params) {
    try {
      var u = new URL(base, window.location.origin);
      Object.keys(params || {}).forEach(function(k){
        var v = params[k];
        if(v !== undefined && v !== null && String(v).length) {
          u.searchParams.append(k, v);
        }
      });
      return u.toString();
    } catch(e) {
      var s = base || '';
      var p = new URLSearchParams(params || {}).toString();
      if(!p) return s;
      if(s.indexOf('?') === -1) {
        if(s.slice(-1) !== '/') s = s + '/';
        s = s + '?' + p;
      } else {
        s = s + '&' + p;
      }
      return s;
    }
  }

  async function safeFetchJson(url) {
    try {
      var resp = await fetch(url, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
      var text = await resp.text();
      var ct = resp.headers.get('content-type') || '';
      if(resp.status >= 400) {
        console.error('Fetch error', resp.status, url, text.slice(0,800));
        return null;
      }
      if(ct.indexOf('application/json') === -1 && /^\s*</.test(text)) {
        console.error('Expected JSON but received HTML (possible login page or error). URL:', url);
        console.error('Response preview:', text.slice(0,800));
        return null;
      }
      try { return JSON.parse(text || '{}'); }
      catch(e) { console.error('JSON parse failed for', url, e); return null; }
    } catch(e) {
      console.error('Fetch failed for', url, e);
      return null;
    }
  }

  function normalizeColorArray(arr){
    if(!Array.isArray(arr)) return [];
    return arr.map(function(it){
      if(typeof it === 'string') return it;
      if(it && it.name) return it.name;
      if(it && it.label) return it.label;
      return String(it || '');
    }).filter(Boolean);
  }

  function fetchColors(componentId, cb){
    if(!componentId) return cb && cb([]);
    try {
      var master = readMaster();
      if(master && master.components){
        var compData = null;
        if(Array.isArray(master.components)){
          compData = master.components.find(function(c){ return String(c.id||c.pk||'').toLowerCase() === String(componentId).toLowerCase(); });
        } else if(master.components[String(componentId)]) {
          compData = master.components[String(componentId)];
        } else {
          Object.keys(master.components || {}).some(function(k){
            var v = master.components[k];
            if(!v) return false;
            if(String(v.id || k || '').toLowerCase() === String(componentId).toLowerCase()){ compData = v; return true; }
            return false;
          });
        }
        if(compData){
          var arr = compData.colors || compData.color_list || compData.color_values || [];
          if(arr && arr.length) return cb && cb(normalizeColorArray(arr));
        }
      }
    } catch(e){ /* ignore master parse errors */ }

    if(COMPONENTS_COLORS_URL){
      var url = buildUrl(COMPONENTS_COLORS_URL, { component_id: componentId });
      safeFetchJson(url).then(function(payload){
        if(!payload) { fetchColorsFallback(componentId, cb); return; }
        var arr = [];
        if(Array.isArray(payload.colors)) arr = payload.colors;
        else if(Array.isArray(payload.results)) arr = payload.results;
        else if(Array.isArray(payload.items)) arr = payload.items;
        else if(Array.isArray(payload)) arr = payload.slice();
        cb && cb(normalizeColorArray(arr));
      });
      return;
    }

    fetchColorsFallback(componentId, cb);
  }

  function fetchColorsFallback(componentId, cb){
    if(!AJAX_COMPONENT_DETAILS) return cb && cb([]);
    var url = buildUrl(AJAX_COMPONENT_DETAILS, { component_id: componentId });
    safeFetchJson(url).then(function(payload){
      if(!payload) return cb && cb([]);
      var arr = [];
      if(Array.isArray(payload.colors)) arr = payload.colors;
      else if(payload.component && Array.isArray(payload.component.colors)) arr = payload.component.colors;
      else if(Array.isArray(payload.components) && payload.components.length && Array.isArray(payload.components[0].colors)) arr = payload.components[0].colors;
      else if(Array.isArray(payload.results)) arr = payload.results;
      else if(payload.component && payload.component.color_list) arr = payload.component.color_list;
      else if(typeof payload.colors === 'string') arr = payload.colors.split(',').map(function(s){ return s.trim(); });
      cb && cb(normalizeColorArray(arr));
    });
  }

  function renderColors(colors){
    if(!colorContainer) return;
    colorContainer.innerHTML = '';
    if(!colors || !colors.length){
      var note = document.createElement('div'); note.className = 'small-note';
      note.textContent = 'No active colors for this quality/component. You can still enter a color using the primary SKU field.';
      colorContainer.appendChild(note);
      setHidden([]);
      renderSkuPreviews([]);
      return;
    }

    colors.forEach(function(c, idx){
      var safe = String(c);
      var id = 'color_chk_' + idx + '_' + safe.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
      var wrapper = document.createElement('label'); wrapper.className = 'color-chip'; wrapper.htmlFor = id;

      // create swatch with gradient to use the same palette (confident default)
      var swatch = document.createElement('span'); swatch.className = 'color-swatch';
      // choose a gentle tint based on index for visual variety
      var t1 = idx % 3 === 0 ? 'linear-gradient(90deg,#fde68a,#fca5a5)' : (idx % 3 === 1 ? 'linear-gradient(90deg,#a78bfa,#60a5fa)' : 'linear-gradient(90deg,#6ee7b7,#34d399)');
      swatch.style.background = t1;

      var left = document.createElement('div'); left.className = 'color-label';
      var chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = id; chk.name = 'colors[]'; chk.value = safe; chk.setAttribute('aria-label','Color ' + safe);
      var txt = document.createElement('span'); txt.textContent = safe; txt.style.fontWeight = 700; txt.style.color = '#123';
      left.appendChild(chk); left.appendChild(swatch); left.appendChild(txt);

      wrapper.appendChild(left);

      var badge = document.createElement('div'); badge.style.fontSize='0.9rem'; badge.style.color='var(--muted)'; badge.textContent = 'add';
      wrapper.appendChild(badge);

      colorContainer.appendChild(wrapper);
      chk.addEventListener('change', onSelectionChange);
    });

    // preselect
    var initial = (hiddenColors && hiddenColors.value) ? String(hiddenColors.value).split(',').map(function(s){ return s.trim(); }) : [];
    initial.forEach(function(ic){
      var el = Array.from(colorContainer.querySelectorAll('input[type=checkbox]')).find(function(i){ return i.value.toLowerCase() === ic.toLowerCase(); });
      if(el) el.checked = true;
    });

    onSelectionChange();
  }

  function getSelected(){
    if(!colorContainer) return [];
    return Array.from(colorContainer.querySelectorAll('input[type=checkbox]')).filter(function(c){ return c.checked; }).map(function(c){ return c.value; });
  }

  function setHidden(arr){
    if(!hiddenColors) return;
    hiddenColors.value = Array.isArray(arr) ? arr.join(',') : '';
  }

  function onSelectionChange(){
    var sel = getSelected();
    setHidden(sel);
    renderSkuPreviews(sel);
    document.dispatchEvent(new Event('costing:colors:changed'));
  }

  function computeSkuFor(params){
    if(!AJAX_COMPUTE_SKU) return Promise.resolve({ sku: '' });
    var url = buildUrl(AJAX_COMPUTE_SKU, params);
    return safeFetchJson(url).then(function(j){
      if(!j) return { sku: '' };
      return { sku: (j && typeof j.sku === 'string') ? j.sku : '' };
    }).catch(function(){ return { sku: '' }; });
  }

  function getSizeLabel(){
    if(!sizeSelect) return '';
    var idx = sizeSelect.selectedIndex; if(idx < 0) return '';
    var txt = (sizeSelect.options[idx].text || '').trim(); if(txt.indexOf(' —') > -1) txt = txt.split(' —')[0].trim();
    return txt;
  }

  function renderSkuPreviews(colors){
    if(!skuListEl) return;
    skuListEl.innerHTML = '';
    if(!Array.isArray(colors) || colors.length === 0) return;

    // placeholders
    colors.forEach(function(c){
      var li = document.createElement('li'); li.className = 'sku-item';
      li.innerHTML = '<div><strong>' + String(c) + '</strong></div><div class="sku-code">...</div>';
      skuListEl.appendChild(li);
    });

    var compId = componentSelect && componentSelect.value ? componentSelect.value : '';
    var compLabel = '';
    if(componentSelect && componentSelect.selectedIndex >= 0) compLabel = (componentSelect.options[componentSelect.selectedIndex].text || '').trim();
    var nameVal = nameEl && nameEl.value ? nameEl.value.trim() : '';
    var collectionVal = collectionEl && collectionEl.value ? collectionEl.value.trim() : '';
    var sizeVal = getSizeLabel();

    Promise.all(colors.map(function(color){
      if(!nameVal || !collectionVal || !sizeVal) return Promise.resolve({color: color, sku: ''});
      var params = { name: nameVal, collection: collectionVal, color: color, size: sizeVal };
      if(compId) params.component_id = compId;
      if(compLabel) params.component_label = compLabel;
      var catLabel = getEffectiveCategoryLabel();
      if(catLabel) params.category_label = catLabel;
      return computeSkuFor(params).then(function(r){ return { color: color, sku: r.sku }; });
    })).then(function(results){
      skuListEl.innerHTML = '';
      results.forEach(function(res){
        var li = document.createElement('li'); li.className = 'sku-item';
        var left = document.createElement('div'); left.innerHTML = '<strong>' + String(res.color) + '</strong>';
        var right = document.createElement('div'); var code = document.createElement('span'); code.className = 'sku-code'; code.textContent = res.sku || '(no sku)';
        right.appendChild(code);
        var btn = document.createElement('button'); btn.type = 'button'; btn.className = 'btn btn-outline'; btn.style.marginLeft = '8px'; btn.textContent = 'Copy';
        btn.addEventListener('click', function(){ try{ navigator.clipboard && navigator.clipboard.writeText(res.sku || ''); btn.textContent='Copied'; setTimeout(function(){btn.textContent='Copy';},1200);}catch(e){} });
        right.appendChild(btn);
        li.appendChild(left); li.appendChild(right); skuListEl.appendChild(li);
      });
      if(results.length === 1 && primarySkuEl) primarySkuEl.value = results[0].sku || '';
    }).catch(function(){ skuListEl.innerHTML = ''; });
  }

  function getEffectiveCategoryLabel(){
    try {
      if(categoryNewSelect && categoryNewSelect.selectedIndex >= 0){
        var t = (categoryNewSelect.options[categoryNewSelect.selectedIndex].text || '').trim();
        if(t) return t;
      }
      if(categorySelect && categorySelect.selectedIndex >= 0){
        var t2 = (categorySelect.options[categorySelect.selectedIndex].text || '').trim();
        if(t2) return t2;
      }
      return '';
    } catch(e){ return ''; }
  }

  function onComponentChanged(){
    var compId = componentSelect && componentSelect.value ? componentSelect.value : '';
    if(colorContainer) colorContainer.innerHTML = '<div class="small-note">Loading colors for selected quality (component)...</div>';
    fetchColors(compId, function(colors){ renderColors(colors || []); });
  }

  function populateMasters(){
    var master = readMaster() || {};
    var cats = master.categories || [];
    var sizes_by = master.sizes_by_category || {};
    if(categoryNewSelect){
      categoryNewSelect.innerHTML = '<option value="">-- select category master --</option>';
      cats.forEach(function(c){
        var opt = document.createElement('option'); opt.value = c.id || ''; opt.text = c.name || (c.title||''); categoryNewSelect.appendChild(opt);
      });
      var init = categoryNewSelect.getAttribute('data-initial') || '';
      if(init){
        try { categoryNewSelect.value = init; } catch(e) {}
      }
    }

    if(sizeSelect){
      function populateSizesForCategory(cid){
        sizeSelect.innerHTML = '<option value="">-- select size --</option>';
        var arr = sizes_by[String(cid)] || [];
        arr.forEach(function(sz){
          var opt = document.createElement('option'); opt.value = sz.id || sz.size || sz.name || ''; opt.text = sz.size || sz.name || String(sz.id || '');
          sizeSelect.appendChild(opt);
        });
        var initSize = sizeSelect.getAttribute('data-initial') || '';
        if(initSize) {
          try { sizeSelect.value = initSize; } catch(e) {}
        }
      }

      if(categoryNewSelect){
        categoryNewSelect.addEventListener('change', function(){
          populateSizesForCategory(categoryNewSelect.value);
          sizeSelect.dispatchEvent(new Event('change',{bubbles:true}));
        });
        var initCat = categoryNewSelect.getAttribute('data-initial') || (categoryNewSelect.value || '');
        if(initCat) populateSizesForCategory(initCat);
      }
    }
  }

  function init(){
    populateMasters();
    if(categorySelect){
      var init = categorySelect.getAttribute('data-initial') || '';
      if(init){
        try { categorySelect.value = init; } catch(e){}
      }
    }
    if(componentSelect && componentSelect.value) {
      setTimeout(onComponentChanged, 40);
    }
    if(componentSelect){
      componentSelect.addEventListener('change', function(){ onComponentChanged(); dispatchCategoryChange(); });
      if(componentSelect.value) setTimeout(onComponentChanged, 40);
    }

    document.addEventListener('costing:colors:changed', computePrimarySKUDebounced);
    if(nameEl) { nameEl.addEventListener('input', computePrimarySKUDebounced); nameEl.addEventListener('change', computePrimarySKUDebounced); }
    if(collectionEl) { collectionEl.addEventListener('input', computePrimarySKUDebounced); collectionEl.addEventListener('change', computePrimarySKUDebounced); }
    if(sizeSelect) sizeSelect.addEventListener('change', computePrimarySKUDebounced);
    if(componentSelect) componentSelect.addEventListener('change', computePrimarySKUDebounced);
    if(categorySelect) categorySelect.addEventListener('change', computePrimarySKUDebounced);
    if(categoryNewSelect) categoryNewSelect.addEventListener('change', computePrimarySKUDebounced);

    var btn = document.getElementById('btn_add_accessory_qty');
    if(btn) btn.addEventListener('click', function(){
      var qtyEl = document.getElementById('id_accessory_quantity'); if(!qtyEl) return;
      var n = parseInt(qtyEl.value) || 0; qtyEl.value = n + 1; qtyEl.dispatchEvent(new Event('change',{bubbles:true}));
    });

    setTimeout(computePrimarySKU, 300);
  }

  var tpk = null;
  function computePrimarySKUDebounced(){
    clearTimeout(tpk); tpk = setTimeout(computePrimarySKU, 220);
  }
  function computePrimarySKU(){
    try {
      var selected = getSelected();
      var color = (selected && selected.length === 1) ? selected[0] : (document.getElementById('id_color') ? document.getElementById('id_color').value : '');
      var nameVal = nameEl && nameEl.value ? nameEl.value.trim() : '';
      var collectionVal = collectionEl && collectionEl.value ? collectionEl.value.trim() : '';
      var sizeVal = getSizeLabel();
      var category_id = (categorySelect && categorySelect.value) ? categorySelect.value : '';
      var category_label = getEffectiveCategoryLabel();

      if(!category_label || !nameVal || !collectionVal || !color || !sizeVal){
        if(primarySkuEl) primarySkuEl.value = '';
        return;
      }

      var params = { name: nameVal, collection: collectionVal, color: color, size: sizeVal, category_label: category_label };
      if(category_id) params.category_id = category_id;

      computeSkuFor(params).then(function(r){
        if(primarySkuEl) primarySkuEl.value = r.sku || '';
      });
    } catch(e){ console.error('computePrimarySKU error', e); }
  }

  function dispatchCategoryChange(){
    var ev = new Event('change',{bubbles:true}); document.dispatchEvent(ev);
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else setTimeout(init, 0);

  window.CostingColorUI = { fetchColors: fetchColors, renderColors: renderColors, getSelected: getSelected, computeSkuFor: computeSkuFor };
})();
</script>

<!-- Include external costing.js (unchanged file) with cache-buster. If you do not have it, this acts no-op -->
<script>
(function(){
  try {
    var already = Array.from(document.getElementsByTagName('script')).some(function(s){ return s.src && s.src.indexOf('costing.js') !== -1; });
    if(!already){
      var s = document.createElement('script');
      s.src = "{% static 'costing_sheet/costing.js' %}?v=2";
      s.defer = true; document.head.appendChild(s);
    }
  } catch(e){}
})();
</script>

<!-- computeAll and remaining wiring (kept compact and functional) -->
<script>
(function(){
  function toDecimal(v){ var n = parseFloat(v); return isNaN(n) ? 0 : n; }
  function pctToMul(p){ return 1 + (toDecimal(p) / 100.0); }
  function getInputVal(id){ var el = document.getElementById(id); if(!el) return 0; return toDecimal(el.value); }
  function setVal(id, v, fixed){ var el = document.getElementById(id); if(!el) return; if(typeof fixed === "number") el.value = isFinite(v) ? Number(v).toFixed(fixed) : "0.0000"; else el.value = (v===null||v===undefined) ? "" : v; }

  function updateTotalLabelText(){
    var sel = document.getElementById('id_total_basis'), label = document.getElementById('total_label_text'); if(!label||!sel) return;
    label.textContent = sel.value === 'price_per_sqft' ? "(Price / sq.ft × Average)" : "(Final Cost × Average)";
  }

  window.computeAll = function(){
    try {
      var final_cost = getInputVal("id_final_cost");
      var price_per_sqft = getInputVal("id_price_per_sqft");
      var avg = getInputVal("id_average");
      var basisEl = document.getElementById('id_total_basis'), basis = basisEl ? basisEl.value : 'final_cost';
      var total_basis_value = basis === 'price_per_sqft' ? price_per_sqft : final_cost;
      var total = total_basis_value * avg; setVal("id_total", total, 4);
      updateTotalLabelText();

      var accessory_line = getInputVal("id_accessory_line_total");
      var stitching = getInputVal("id_new_stitching");
      var finishing = getInputVal("id_new_finishing");
      var packaging = getInputVal("id_new_packaging");

      var effective_final_price = total + stitching + finishing + packaging + accessory_line;
      setVal("id_new_final_price", effective_final_price, 4);

      var gf_percent = getInputVal("id_gf_percent") || getInputVal("id_gf_percent_display");
      var texas_buying_percent = getInputVal("id_texas_buying_percent") || getInputVal("id_texas_buying_percent_display");
      var texas_retail_percent = getInputVal("id_texas_retail_percent") || getInputVal("id_texas_retail_percent_display");
      var tx_to_us_percent = getInputVal("id_tx_to_us_percent") || getInputVal("id_tx_to_us_percent_display");
      var import_percent = getInputVal("id_import_percent") || getInputVal("id_import_percent_display");

      var gf_overhead = effective_final_price * pctToMul(gf_percent);
      setVal("id_gf_overhead_cost", gf_overhead, 4);

      var texas_buying = gf_overhead * pctToMul(texas_buying_percent); setVal("id_texas_buying_cost", texas_buying, 4);
      var shipping_inr = getInputVal("id_shipping_cost_india") || getInputVal("id_shipping_inr_display") || getInputVal("id_shipping_inr");
      var texas_retail = (texas_buying * pctToMul(texas_retail_percent)) + shipping_inr; setVal("id_texas_retail", texas_retail, 4);
      var texas_us_selling = texas_buying * pctToMul(tx_to_us_percent); setVal("id_texas_us_selling_cost", texas_us_selling, 4);

      var partA = texas_us_selling * pctToMul(import_percent);
      var partB = (texas_us_selling * pctToMul(getInputVal("id_ship_us_percent")||0)) / 80.0;
      var us_buying = partA + partB; setVal("id_us_buying_cost_usd", us_buying, 4);

      var us_wholesale_cost = (us_buying * pctToMul(getInputVal("id_us_wholesale")||0)) / 0.85;
      setVal("id_us_wholesale_cost", isFinite(us_wholesale_cost) ? us_wholesale_cost : 0, 4);

      // keep visual consistency — nothing to show in removed summary, values update form fields
    } catch(e){ console.warn("computeAll() failed", e); }
  };

  var idsToWatch = [
    "id_average","id_final_cost","id_price_per_sqft","id_total_basis",
    "id_shipping_cost_india","id_shipping_cost_us","id_shipping_cost_europe",
    "id_gf_percent","id_gf_percent_display",
    "id_texas_buying_percent","id_texas_buying_percent_display",
    "id_texas_retail_percent","id_texas_retail_percent_display",
    "id_tx_to_us_percent","id_tx_to_us_percent_display",
    "id_import_percent","id_import_percent_display",
    "id_accessory_line_total","id_new_stitching","id_new_finishing","id_new_packaging",
    "id_accessory_unit_price","id_accessory_quantity"
  ];

  function attachListeners(){
    idsToWatch.forEach(function(i){ var el = document.getElementById(i); if(el){ el.addEventListener('input', computeAll); el.addEventListener('change', computeAll); }} );
    var accUnitEl = document.getElementById("id_accessory_unit_price"), accQtyEl = document.getElementById("id_accessory_quantity");
    function updateAccessoryLine(){ var up = toDecimal(accUnitEl?accUnitEl.value:0); var q = parseInt(accQtyEl?accQtyEl.value:0)||0; var line = up*q; var disp=document.getElementById("id_accessory_line_total_display"); if(disp) disp.value = isFinite(line)?line.toFixed(2):"0.00"; var hidden=document.getElementById("id_accessory_line_total"); if(hidden){ hidden.value = isFinite(line)?line.toFixed(2):"0.00"; hidden.dispatchEvent(new Event('change',{bubbles:true})); } }
    if(accUnitEl) accUnitEl.addEventListener('input', updateAccessoryLine);
    if(accQtyEl){ accQtyEl.addEventListener('input', updateAccessoryLine); accQtyEl.addEventListener('change', updateAccessoryLine); }
    ["id_new_stitching","id_new_finishing","id_new_packaging"].forEach(function(id){ var el=document.getElementById(id); if(el){ el.addEventListener('input', computeAll); el.addEventListener('change', computeAll); }} );
  }

  document.addEventListener("DOMContentLoaded", function(){ attachListeners(); updateTotalLabelText(); computeAll(); setTimeout(computeAll,250); setTimeout(computeAll,1000); });
})();
</script>
{% endblock %}
