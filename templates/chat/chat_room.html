{% extends "base.html" %}

{# 1. page title block #}
{% block title %}Global Chat Room{% endblock %}

{# 2. main content block - adjust name if your base.html uses a different block name (e.g. 'body' or 'main') #}
{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Global Chat</h5>
        </div>

        <div class="card-body" id="chat-body" style="height:400px; overflow:auto; background:#f9f9f9;">
          <ul id="messages" class="list-unstyled mb-0">
            {# messages will be appended here by JS #}
          </ul>
        </div>

        <div class="card-footer">
          <form id="chat-form" onsubmit="return false;">
            <div class="input-group">
              <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message..." autocomplete="off" />
              <button id="chat-message-submit" class="btn btn-primary">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# 3. JS block - ensure this block name matches your base.html (commonly 'extra_js' or 'scripts') #}
{% block extra_js %}
<script>
  (function() {
    // Build WebSocket URL depending on current protocol
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocketUrl = wsScheme + '://' + window.location.host + '/ws/chat/global/';

    let chatSocket = null;
    function connect() {
      chatSocket = new WebSocket(chatSocketUrl);

      chatSocket.onopen = function(e) {
        console.log('WebSocket connected:', chatSocketUrl);
        appendSystemMessage('Connected to chat');
      };

      chatSocket.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          if (data.message) {
            appendMessage(data.username || 'Anonymous', data.message);
          } else {
            console.log('Unknown message payload', data);
          }
        } catch (err) {
          console.error('Failed to parse message', err, e.data);
        }
      };

      chatSocket.onclose = function(e) {
        console.warn('WebSocket closed. Reconnecting in 2s...', e);
        appendSystemMessage('Disconnected â€” reconnecting...');
        setTimeout(connect, 2000);
      };

      chatSocket.onerror = function(err) {
        console.error('WebSocket error', err);
      };
    }

    function appendMessage(user, text) {
      const ul = document.getElementById('messages');
      const li = document.createElement('li');
      li.innerHTML = `<strong>${escapeHtml(user)}:</strong> ${escapeHtml(text)}`;
      ul.appendChild(li);
      scrollChatToBottom();
    }

    function appendSystemMessage(text) {
      const ul = document.getElementById('messages');
      const li = document.createElement('li');
      li.style.fontStyle = 'italic';
      li.textContent = text;
      ul.appendChild(li);
      scrollChatToBottom();
    }

    function scrollChatToBottom() {
      const body = document.getElementById('chat-body');
      body.scrollTop = body.scrollHeight;
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replaceAll('&', "&amp;")
        .replaceAll('<', "&lt;")
        .replaceAll('>', "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    document.getElementById('chat-message-submit').addEventListener('click', function() {
      const input = document.getElementById('chat-message-input');
      const message = input.value.trim();
      if (!message || chatSocket.readyState !== WebSocket.OPEN) return;
      const payload = JSON.stringify({ message: message });
      chatSocket.send(payload);
      input.value = '';
    });

    // Allow Enter to send
    document.getElementById('chat-message-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('chat-message-submit').click();
      }
    });

    // Start connection
    connect();
  })();
</script>
{% endblock %}
