{% extends "base.html" %}
{% load static %}

{% block page_title %}
  {% if form.instance.pk %}Edit{% else %}Create{% endif %} Component
{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h4 class="card-title mb-3">
      {% if form.instance.pk %}Edit{% else %}Create{% endif %} Component
    </h4>

    <form method="post" enctype="multipart/form-data" novalidate id="component-form">
      {% csrf_token %}

      {# Non-field errors #}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      {# ------------------ If this is ComponentMasterForm (has cost_per_unit) ------------------ #}
      {# Allow view to explicitly set `is_master_form`; otherwise fall back to checking for the field #}
      {% if is_master_form or form.fields.cost_per_unit %}
        <div class="row g-3">

          {# NOTE: Name removed from UI (auto-generated). Do NOT show name input. #}

          <div class="col-md-4">
            {{ form.inventory_category.label_tag }}
            {{ form.inventory_category }}
            {% if form.inventory_category.errors %}
              <div class="text-danger small">{{ form.inventory_category.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-8">
            <label class="form-label">Product (select from inventory)</label>
            <select id="component_product_select" class="form-select" aria-label="Product select">
              <option value="">-- Select product (choose category first) --</option>
            </select>
            <div id="component_product_help" class="form-text"></div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Quality / Variant</label>

            {# Render server-side widget safely; small client patch below will ensure id/class exist #}
            {{ form.quality }}
            <div id="component_quality_help" class="form-text"></div>
            {% if form.quality.errors %}
              <div class="text-danger small">{{ form.quality.errors }}</div>
            {% endif %}
          </div>

          {# SIZE removed from UI; computations will use default size = 1.00 #}
          {# <div class="col-md-2"> ... size ... </div> removed intentionally #}

          <div class="col-md-3">
            <label class="form-label">Cost per unit</label>
            {{ form.cost_per_unit }}
            {% if form.cost_per_unit.errors %}
              <div class="text-danger small">{{ form.cost_per_unit.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-3">
            {{ form.logistics_percent.label_tag }}
            {{ form.logistics_percent }}
            {% if form.logistics_percent.errors %}
              <div class="text-danger small">{{ form.logistics_percent.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-2">
            <label class="form-label">Width</label>
            {{ form.width }}
            {% if form.width.errors %}
              <div class="text-danger small">{{ form.width.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-2">
            <label class="form-label">Width UoM</label>
            {{ form.width_uom }}
            {% if form.width_uom.errors %}
              <div class="text-danger small">{{ form.width_uom.errors }}</div>
            {% endif %}
          </div>

          {# New readonly Type field (form provides form.type) #}
          <div class="col-md-4">
            <label class="form-label">Type</label>
            {% if form.type %}
              {{ form.type }}
            {% else %}
              <input type="text" id="id_type" readonly class="form-control" aria-readonly="true" />
            {% endif %}
            <div id="component_type_help" class="form-text"></div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Final price per unit (price + logistics%)</label>
            {{ form.final_price_per_unit }}
            {% if form.final_price_per_unit.errors %}
              <div class="text-danger small">{{ form.final_price_per_unit.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label class="form-label">Price per sq. foot</label>
            {{ form.price_per_sqfoot }}
            {% if form.price_per_sqfoot.errors %}
              <div class="text-danger small">{{ form.price_per_sqfoot.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label class="form-label">Final cost (size × unit × (1 + logistics%))</label>
            {{ form.final_cost }}
            {% if form.final_cost.errors %}
              <div class="text-danger small">{{ form.final_cost.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            {{ form.notes.label_tag }}
            {{ form.notes }}
            {% if form.notes.errors %}
              <div class="text-danger small">{{ form.notes.errors }}</div>
            {% endif %}
          </div>

          {# Colors panel (new) #}
          <div class="col-12 mt-2">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="mb-0">Colors</h5>
              <div>
                <button type="button" id="btn-add-color" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addColorModal">
                  + Add Color
                </button>
              </div>
            </div>

            <div id="colors-container" class="mb-2">
              {# color chips + checkboxes will be rendered by JS #}
              <div class="text-muted small" id="colors-empty-text">No colors added yet for this component.</div>
              <div id="colors-list" class="d-flex flex-wrap gap-2"></div>
            </div>

            <div class="form-text">Check the colors you want SKUs generated for. Selected colors are submitted with the form.</div>
            {# Hidden input to submit selected color ids as comma-separated list #}
            <input type="hidden" name="selected_color_ids" id="selected_color_ids" value="" />
          </div>

          {# Hidden name field (auto-generated by client JS). Keep it so server receives the name. #}
          {{ form.name }}

          {# Hidden inventory linking fields required by the forms #}
          {{ form.inventory_content_type }}
          {{ form.inventory_object_id }}
        </div>

      {# ------------------ Fallback: CostComponentForm UI ------------------ #}
      {% else %}
        <div class="mb-3">
          {{ form.name.label_tag }}
          {{ form.name }}
          {% if form.name.errors %}
            <div class="text-danger small">{{ form.name.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.inventory_category.label_tag }}
          {{ form.inventory_category }}
          {% if form.inventory_category.errors %}
            <div class="text-danger small">{{ form.inventory_category.errors }}</div>
          {% endif %}
        </div>

        {# Product & quality selectors are present here too (so user can pick an inventory item) #}
        <div class="mb-3">
          <label class="form-label">Product (select from inventory)</label>
          <select id="component_product_select" class="form-select" aria-label="Product select">
            <option value="">-- Select product (choose category first) --</option>
          </select>
          <div id="component_product_help" class="form-text"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Quality / Variant</label>

          {{ form.quality }}
          <div id="component_quality_help" class="form-text"></div>
          {% if form.quality.errors %}
            <div class="text-danger small">{{ form.quality.errors }}</div>
          {% endif %}
        </div>

        {% if form.inventory_selector %}
          <div class="mb-3">
            {{ form.inventory_selector.label_tag }}
            {{ form.inventory_selector }}
            {% if form.inventory_selector.errors %}
              <div class="text-danger small">{{ form.inventory_selector.errors }}</div>
            {% endif %}
          </div>
        {% endif %}

        {{ form.inventory_content_type }}
        {{ form.inventory_object_id }}

        <div class="mb-3">
          {{ form.value_type.label_tag }}
          {{ form.value_type }}
          {% if form.value_type.errors %}
            <div class="text-danger small">{{ form.value_type.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.value.label_tag }}
          {{ form.value }}
          {% if form.value.errors %}
            <div class="text-danger small">{{ form.value.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.description.label_tag }}
          {{ form.description }}
          {% if form.description.errors %}
            <div class="text-danger small">{{ form.description.errors }}</div>
          {% endif %}
        </div>

        <div class="form-check mb-3">
          {{ form.is_active }}
          {{ form.is_active.label_tag }}
          {% if form.is_active.errors %}
            <div class="text-danger small">{{ form.is_active.errors }}</div>
          {% endif %}
        </div>
      {% endif %}

      {# Buttons #}
      <div class="mt-4">
        {% if not form.instance.pk %}
          {# Accept either componentmaster or costcomponent add permission to allow Save #}
          {% if perms.components.add_componentmaster or perms.components.add_costcomponent or user.is_superuser %}
            <button type="submit" class="btn btn-success">Save</button>
          {% else %}
            <button type="button" class="btn btn-secondary" disabled>
              You don't have permission to save
            </button>
          {% endif %}
        {% else %}
          {# Accept either change permission #}
          {% if perms.components.change_componentmaster or perms.components.change_costcomponent or user.is_superuser %}
            <button type="submit" class="btn btn-success">Update</button>
          {% else %}
            <button type="button" class="btn btn-secondary" disabled>
              You don't have permission to update
            </button>
          {% endif %}
        {% endif %}
        <a class="btn btn-outline-secondary" href="{% url 'components:list' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>

{# Add Color Modal #}
<div class="modal fade" id="addColorModal" tabindex="-1" aria-labelledby="addColorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="add-color-form">
        <div class="modal-header">
          <h5 class="modal-title" id="addColorModalLabel">Add Color</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="add-color-error" class="text-danger small d-none"></div>
          <div class="mb-3">
            <label for="new-color-name" class="form-label">Color name</label>
            <input type="text" id="new-color-name" name="name" class="form-control" placeholder="e.g. Red" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Color</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ======================================================= #}
{# Define CONFIG first, then include JS (correct order)   #}
{# ======================================================= #}

<script>
  window.COMPONENT_FORM_CONFIG = {
    urls: {
      inventory_items: "{% url 'components:inventory-items-json' %}",
      inventory_qualities: "{% url 'components:inventory-qualities-json' %}",
      inventory_cost: "{% url 'components:inventory-cost-json' %}",
      qualities_by_category: "{% url 'components:qualities-by-category-json' %}",
      types_by_quality: "{% url 'components:types-by-quality-json' %}",
      inventory_item: "{% url 'components:inventory-item-json' %}",
      // color endpoints
      colors_list: "{% url 'components:colors-list-json' %}",
      color_create: "{% url 'components:color-create-json' %}",
      color_delete: "{% url 'components:color-delete-json' %}"
    },
    csrfToken: "{{ csrf_token }}",
    selectors: {
      productSelect: "#component_product_select",
      qualitySelect: "#component_quality_select",
      // size removed: keep entry null so existing JS doesn't blow up if it expects this key
      sizeInput: null,
      logisticsInput: "#id_logistics_percent",
      costInput: "#id_cost_per_unit",
      widthInput: "#id_width",
      widthUomInput: "#id_width_uom",
      finalPriceInput: "#id_final_price_per_unit",
      pricePerSqftInput: "#id_price_per_sqfoot",
      finalCostInput: "#id_final_cost",
      hiddenCT: "#id_inventory_content_type",
      hiddenOID: "#id_inventory_object_id",
      categorySelect: "#id_inventory_category",
      // new selector for type (form.type or fallback input)
      typeInput: "#id_type"
    }
  };
</script>

<script src="{% static 'components/js/component_form.js' %}"></script>

{# Colors client-side logic: fetch, render, add, delete, and maintain selected_color_ids #}
<script>
(function () {
  const cfg = window.COMPONENT_FORM_CONFIG || {};
  const urls = cfg.urls || {};
  const csrfToken = cfg.csrfToken || "";
  const compForm = document.getElementById("component-form");

  // Helper: read current component id (if editing)
  function getComponentId() {
    // Attempt to read from the form's action or a data attribute.
    // Prefer server-provided pk via form.instance in template context as an input? Fallback to URL parsing.
    const pkEl = document.querySelector('input[name="id"]') || null;
    // Try instance pk from Django's form instance rendered as id in form: use form.instance.pk via template? Not present.
    // As fallback, try to parse window.location for /master/<pk>/edit or /master/<pk> pattern.
    const m = window.location.pathname.match(/\/master\/(\d+)(\/|$)/);
    if (m) return m[1];
    return ""; // empty when creating new component (colors will be empty until created)
  }

  // DOM refs
  const colorsListEl = document.getElementById("colors-list");
  const colorsEmptyText = document.getElementById("colors-empty-text");
  const selectedInput = document.getElementById("selected_color_ids");
  const addColorForm = document.getElementById("add-color-form");
  const newColorNameInput = document.getElementById("new-color-name");
  const addColorError = document.getElementById("add-color-error");

  // fetch and render colors (for existing component)
  async function loadColors() {
    const compId = getComponentId();
    // if no compId (new), clear UI and return
    if (!compId) {
      renderColors([]);
      return;
    }
    try {
      const res = await fetch(urls.colors_list + "?component_id=" + encodeURIComponent(compId), {
        headers: { "Accept": "application/json" },
        credentials: "same-origin"
      });
      if (!res.ok) throw new Error("Failed to load colors");
      const data = await res.json();
      const list = data.results || [];
      renderColors(list);
    } catch (err) {
      console.warn("loadColors error", err);
      renderColors([]);
    }
  }

  // Render color chips with checkboxes
  function renderColors(colors) {
    colorsListEl.innerHTML = "";
    if (!colors || colors.length === 0) {
      colorsEmptyText.style.display = "";
      selectedInput.value = "";
      return;
    }
    colorsEmptyText.style.display = "none";

    colors.forEach(c => {
      const wrapper = document.createElement("div");
      wrapper.className = "border rounded px-2 py-1 d-flex align-items-center";
      wrapper.style.minWidth = "140px";
      wrapper.style.gap = "8px";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "form-check-input me-2 color-checkbox";
      chk.dataset.colorId = c.id;
      chk.id = "color_chk_" + c.id;

      // label text
      const lbl = document.createElement("label");
      lbl.htmlFor = chk.id;
      lbl.className = "mb-0 small";
      lbl.textContent = c.name;

      // Delete button (small)
      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn btn-link btn-sm text-danger ms-2";
      delBtn.style.padding = "0 .3rem";
      delBtn.title = "Remove color";
      delBtn.textContent = "✕";
      delBtn.dataset.colorId = c.id;

      // assemble
      wrapper.appendChild(chk);
      wrapper.appendChild(lbl);
      wrapper.appendChild(delBtn);

      colorsListEl.appendChild(wrapper);

      // checkbox change updates selected_input
      chk.addEventListener("change", updateSelectedInput);

      // delete handler
      delBtn.addEventListener("click", async function () {
        if (!confirm("Remove color \"" + c.name + "\"?")) return;
        try {
          const fd = new FormData();
          fd.append("color_id", c.id);
          const resp = await fetch(urls.color_delete, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            credentials: "same-origin",
            body: fd
          });
          const j = await resp.json();
          if (resp.ok && j.success) {
            // remove chip from DOM and update selected list
            wrapper.remove();
            updateSelectedInput();
            // If none left show empty text
            if (!colorsListEl.children.length) colorsEmptyText.style.display = "";
          } else {
            alert("Could not remove color: " + (j.error || "unknown error"));
          }
        } catch (err) {
          console.warn("color delete failed", err);
          alert("Failed to delete color");
        }
      });
    });

    // restore previously selected IDs if any (for edit forms)
    // if the page included a server-side value for selected_color_ids, it'll be picked up automatically (value attr).
    // No further action needed.
    updateSelectedInput();
  }

  // Compose selected IDs CSV for submission
  function updateSelectedInput() {
    const checked = Array.from(document.querySelectorAll(".color-checkbox:checked")).map(i => i.dataset.colorId);
    selectedInput.value = checked.join(",");
  }

  // Add color form submit handler
  addColorForm.addEventListener("submit", async function (ev) {
    ev.preventDefault();
    addColorError.classList.add("d-none");
    const compId = getComponentId();
    const name = (newColorNameInput.value || "").trim();
    if (!compId) {
      addColorError.textContent = "Please save the component first (create it) before adding colors.";
      addColorError.classList.remove("d-none");
      return;
    }
    if (!name) {
      addColorError.textContent = "Provide a color name.";
      addColorError.classList.remove("d-none");
      return;
    }
    try {
      const fd = new FormData();
      fd.append("component_id", compId);
      fd.append("name", name);
      const resp = await fetch(urls.color_create, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        credentials: "same-origin",
        body: fd
      });
      const j = await resp.json();
      if (resp.ok && j.success && j.color) {
        // close modal, clear input, reload colors
        const modalEl = document.getElementById("addColorModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        newColorNameInput.value = "";
        await loadColors();
      } else {
        const err = j.error || "Failed to create color";
        addColorError.textContent = err;
        addColorError.classList.remove("d-none");
      }
    } catch (err) {
      console.warn("create color error", err);
      addColorError.textContent = "Failed to create color";
      addColorError.classList.remove("d-none");
    }
  });

  // wire-up: when inventory/category/quality selection changes, reload colors as appropriate
  // (Colors are attached to ComponentMaster instances not inventory items; still keep loader on page load)
  document.addEventListener("DOMContentLoaded", function () {
    // ensure quality id/class patched if needed (from earlier client patch)
    const qname = "{{ form.quality.name|default:'' }}";
    if (qname) {
      const el = document.querySelector('[name="' + qname + '"]');
      if (el) {
        if (!el.id || el.id.trim() === "") el.id = "component_quality_select";
        if (el.tagName.toLowerCase() === "select" && !el.classList.contains("form-select")) el.classList.add("form-select");
      }
    }

    // Load colors (for existing component)
    loadColors();

    // Keep selected list synced before submit
    compForm.addEventListener("submit", function () {
      updateSelectedInput();
    });
  });

  // Expose loadColors so other scripts can refresh the list after save / create
  window.COMPONENT_COLORS = {
    load: loadColors,
    render: renderColors
  };

})();
</script>

{# Client-side patch to ensure the rendered quality widget has expected id/class/aria-label.
   This avoids embedding complex Python calls inside the template and keeps server rendering safe. #}
<script>
(function () {
  try {
    const qname = "{{ form.quality.name|default:'' }}";
    if (qname) {
      // use querySelector to find whichever widget the form rendered (select/input)
      const el = document.querySelector('[name="' + qname + '"]');
      if (el) {
        // ensure id expected by JS
        if (!el.id || el.id.trim() === "") el.id = "component_quality_select";
        // ensure bootstrap form-select class present for selects; add if missing
        if (!el.classList.contains("form-select")) el.classList.add("form-select");
        // ensure aria-label for accessibility
        if (!el.getAttribute("aria-label")) el.setAttribute("aria-label", "Quality select");
      }
    }
  } catch (err) {
    // non-fatal
    console.warn("component_form: failed to patch quality element attributes", err);
  }
})();
</script>

{# Defensive: ensure product options display inventory type when available.
   This rewrites option text to prefer data-type and watches for changes. #}
<script>
(function () {
  try {
    const prod = document.querySelector("#component_product_select");
    if (!prod) return;

    function preferTypeOnOptions() {
      for (let i = 0; i < prod.options.length; i++) {
        const o = prod.options[i];
        // prefer data-type attribute (set by component_form.js) if present & non-empty
        const t = o.dataset && o.dataset.type ? String(o.dataset.type).trim() : "";
        if (t) {
          // preserve placeholder option (has empty value)
          if (o.value) o.text = t;
        }
      }
    }

    // Run once now (for already-populated options)
    preferTypeOnOptions();

    // Observe future changes (options added/removed)
    const mo = new MutationObserver(preferTypeOnOptions);
    mo.observe(prod, { childList: true });

    // Cleanup on page unload to avoid leaks
    window.addEventListener("unload", () => mo.disconnect());
  } catch (err) {
    // swallow errors — non-critical enhancement
    console.warn("[component_form] preferTypeOnOptions error", err);
  }
})();
</script>

{% endblock %}
