{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- ========================= -->
<!--  TOP NAV: E-COM SWITCHER -->
<!-- ========================= -->
<nav class="mb-3">
  <div class="nav nav-tabs">
    <a class="nav-item nav-link {% if 'shopify' in request.path %}active{% endif %}"
       href="{% url 'workorders:shopify_list' %}">
       Shopify
    </a>

    <a class="nav-item nav-link {% if 'faire' in request.path %}active{% endif %}"
       href="{% url 'workorders:faire_list' %}">
       Faire
    </a>

    <a class="nav-item nav-link {% if 'custom' in request.path %}active{% endif %}"
       href="{% url 'workorders:custom_order_list' %}">
       Custom
    </a>

    <a class="nav-item nav-link ms-auto {% if request.path == '/workorders/' %}active{% endif %}"
       href="{% url 'workorders:list' %}">
       All Orders
    </a>
  </div>
</nav>

<!-- ========================= -->
<!-- WORK ORDER HEADER -->
<!-- ========================= -->

<h2>Work Order #{{ workorder.pk }} ‚Äî {{ workorder.order_id }}</h2>
<p>
  Variant: {{ workorder.variant_ordered }}
  | Qty: {{ workorder.quantity_ordered }}
  | Status: {{ workorder.get_status_display }}
</p>

<div id="workorder-alerts" style="min-height:2.5rem;"></div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Packaging Stages</h3>

  <div>
    <a href="{% url 'workorders:notifications' %}" class="btn btn-sm btn-outline-secondary">
      üîî Notifications
      {% if unread_notifications_count %}
        <span class="badge bg-danger rounded-pill ms-1">{{ unread_notifications_count }}</span>
      {% endif %}
    </a>

    {% if user.is_superuser or user.is_staff or perms.workorders.delete_workorder %}
      <form method="post" action="{% url 'workorders:delete' pk=workorder.pk %}" style="display:inline;">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-danger ms-2" type="submit">üóëÔ∏è Delete WorkOrder</button>
      </form>
    {% endif %}
  </div>
</div>

<!-- ========================= -->
<!-- PACKAGING STAGES TABLE -->
<!-- ========================= -->

{% if stages %}
<table class="table">
  <thead>
    <tr>
      <th>Order</th>
      <th>Stage</th>
      <th>Assigned To</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>

    {% for stage in stages %}
    <tr>
      <td>{{ workorder.pk }}</td>
      <td>{{ stage.stage_name }}</td>

      <!-- ASSIGN / VIEW ASSIGNEE -->
      <td>
        {% if user.is_superuser or user.is_staff %}
          <form method="post" action="{% url 'workorders:stage_action' pk=stage.pk %}"
                style="display:flex;gap:.5rem;align-items:center;">
            {% csrf_token %}
            <input type="hidden" name="action" value="assign">

            <select name="assigned_to" class="form-select form-select-sm" style="min-width:180px;">
              <option value="">-- Unassigned --</option>
              {% for emp in employee_choices %}
                <option value="{{ emp.pk }}" {% if emp.pk == stage.assigned_to_pk %}selected{% endif %}>
                  {{ emp.get_full_name|default:emp.username }}
                </option>
              {% endfor %}
            </select>

            <input type="number" name="time_limit_hours" class="form-control form-control-sm"
                   placeholder="Time (hrs)" style="width:120px;"
                   value="{{ stage.time_limit_hours|default_if_none:'' }}" min="1" />

            <button class="btn btn-sm btn-outline-primary" type="submit">Set</button>
          </form>

          {% if stage.assigned_to %}
            <div class="small text-muted mt-1">
              Current: {{ stage.assigned_to }}
              {% if stage.time_limit_hours %} ‚Ä¢ {{ stage.time_limit_hours }} hrs{% endif %}
              {% if stage.due_by %} ‚Ä¢ Due: {{ stage.due_by|date:"j M Y, H:i" }}{% endif %}
            </div>
          {% endif %}
        {% else %}
          {% if stage.assigned_to %}
            {{ stage.assigned_to }}
          {% else %}
            <span class="text-muted">Unassigned</span>
          {% endif %}
        {% endif %}
      </td>

      <!-- STATUS -->
      <td>
        {{ stage.get_stage_status_display }}
        {% if stage.is_delayed %}
          <span class="text-danger">(Delayed)</span>
        {% endif %}
      </td>

      <!-- ACTION BUTTONS -->
      <td>
        {% if stage.can_act %}
          <!-- Start -->
          <form method="post" class="d-inline" action="{% url 'workorders:stage_action' pk=stage.pk %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="in_progress">
            <button class="btn btn-sm btn-outline-primary"
              {% if stage.stage_status != 'pending' %}disabled{% endif %}>
              Start
            </button>
          </form>

          <!-- Complete -->
          {% if not forloop.last %}
            <form method="post" enctype="multipart/form-data" class="d-inline"
                  action="{% url 'workorders:stage_action' pk=stage.pk %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="complete">
              <input type="file" name="image" class="js-file-input" style="margin-left:0.5rem;">
              <button class="btn btn-sm btn-success"
                      {% if stage.stage_status == 'completed' %}disabled{% endif %}>
                Complete
              </button>
            </form>
          {% else %}
            <!-- Last stage ‚Üí dispatch -->
            <form method="get" action="{% url 'dispatch:new' %}" class="d-inline">
              <input type="hidden" name="workorder_id" value="{{ workorder.id }}">
              <button class="btn btn-sm btn-success"
                      {% if stage.stage_status == 'completed' %}disabled{% endif %}>
                Complete & Proceed to Dispatch
              </button>
            </form>
          {% endif %}

          <!-- Confirm Received -->
          <form method="post" class="d-inline"
                action="{% url 'workorders:stage_action' pk=stage.pk %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="confirm_received">
            <button class="btn btn-sm btn-outline-secondary"
                    {% if stage.received_confirmed %}disabled{% endif %}>
              Confirm Received
            </button>
          </form>

        {% else %}
          <span class="text-muted small">Not assigned to you</span>
        {% endif %}

        {% if stage.image %}
          <div class="mt-2">
            <a href="{{ stage.image.url }}" target="_blank">View image</a>
          </div>
        {% endif %}
      </td>
    </tr>
    {% endfor %}

  </tbody>
</table>

{% else %}
  <div class="alert alert-info">
    No packaging stages are visible to you.
  </div>
{% endif %}

<script src="{% static 'workorders/js/stage_actions.js' %}"></script>
{% endblock %}
