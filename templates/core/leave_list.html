{% extends 'base.html' %}
{% load tz %}
{% block page_title %}Leave Applications{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">
    {% if is_admin_user %}
      Leave Applications (Admin)
    {% else %}
      My Leave Applications
    {% endif %}
  </h3>

  {% if leaves %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">#</th>
            {% if is_admin_user %}
              <th scope="col">Applicant</th>
            {% endif %}
            <th scope="col">Type</th>
            <th scope="col">Start Date</th>
            <th scope="col">End Date</th>
            <th scope="col">Duration</th>
            <th scope="col">Reason</th>
            <th scope="col">Status</th>
            <th scope="col">Applied On</th>
            {% if is_admin_user %}
              <th scope="col">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for leave in leaves %}
            <tr>
              <td>{{ forloop.counter }}</td>

              {% if is_admin_user %}
                <td>{{ leave.applicant.get_full_name|default:leave.applicant.username }}</td>
              {% endif %}

              <td>{{ leave.get_leave_type_display }}</td>
              <td>{{ leave.start_date }}</td>
              <td>{{ leave.end_date }}</td>
              <td>{{ leave.duration_days }} day{% if leave.duration_days > 1 %}s{% endif %}</td>
              <td>
                {% if leave.reason %}
                  {{ leave.reason|linebreaksbr|truncatechars:120 }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if leave.status == 'pending' %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif leave.status == 'approved' %}
                  <span class="badge bg-success">Approved</span>
                {% elif leave.status == 'rejected' %}
                  <span class="badge bg-danger">Rejected</span>
                {% endif %}
              </td>
              <td>{{ leave.applied_at|localtime|date:"M d, Y h:i A" }}</td>

              {% if is_admin_user %}
                <td>
                  {% if leave.status == 'pending' %}
                    <!-- Approve form -->
                    <form method="post" action="{% url 'core:approve_leave' leave.pk %}" class="d-inline-block me-1 action-approve-form">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="approve">
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button type="submit" class="btn btn-sm btn-success action-approve-btn" data-applicant="{{ leave.applicant.get_full_name|default:leave.applicant.username }}">
                        Approve
                      </button>
                    </form>

                    <!-- Reject form -->
                    <form method="post" action="{% url 'core:approve_leave' leave.pk %}" class="d-inline-block action-reject-form">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="reject">
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <input type="hidden" name="notes" class="reject-notes-input" value="">
                      <button type="button" class="btn btn-sm btn-outline-danger action-reject-btn" data-applicant="{{ leave.applicant.get_full_name|default:leave.applicant.username }}">
                        Reject
                      </button>
                    </form>
                  {% else %}
                    <small class="text-muted">—</small>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info mt-4">
      No leave applications found.
    </div>
  {% endif %}

  <div class="mt-3 d-flex justify-content-between">
    {% if not is_admin_user %}
      <a href="{% url 'core:apply_leave' %}" class="btn btn-primary">Apply for New Leave</a>
    {% endif %}
    <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">← Back to Dashboard</a>
  </div>
</div>

<!-- Small JS: confirmation + inline reject notes -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // simple confirm for approve
  document.querySelectorAll('.action-approve-btn').forEach(function(btn){
    btn.addEventListener('click', function(evt){
      var name = btn.dataset.applicant || 'this applicant';
      if (!confirm('Approve leave for ' + name + ' ?')) {
        return;
      }
      // submit parent form
      btn.closest('form').submit();
    });
  });

  // reject: prompt for optional notes, then submit
  document.querySelectorAll('.action-reject-btn').forEach(function(btn){
    btn.addEventListener('click', function(evt){
      var name = btn.dataset.applicant || 'this applicant';
      var notes = prompt('Reject leave for ' + name + '. Enter optional notes (reason):', '');
      // find the hidden input in sibling form
      var form = btn.closest('form');
      var notesInput = form.querySelector('.reject-notes-input');
      if (notesInput) notesInput.value = notes || '';
      // confirm final
      if (!confirm('Are you sure you want to reject the leave for ' + name + ' ?')) {
        return;
      }
      form.submit();
    });
  });
});
</script>

{% endblock %}
