{# templates/rawmaterials/parties/printed_list.html #}
{# Expects `printeds`, `can_create`, `can_edit`, `can_delete` in context #}

<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center bg-light">
    <h6 class="mb-0 fw-semibold">Printed</h6>

    <div class="d-flex gap-2">
      {% if can_create %}
        <a href="{% url 'rawmaterials:printed_create' %}" class="btn btn-sm btn-primary">Add Printed</a>
      {% endif %}

      {# Download CSV button (server enforces permissions) #}
      {% if can_create %}
        <a href="{% url 'rawmaterials:printed_download_csv' %}" class="btn btn-sm btn-outline-secondary" title="Download all printed items as CSV">
          Download CSV
        </a>
      {% endif %}
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Fabric</th>
            <th>Quality</th>
            <th>Base Color</th>
            <th>Type</th>
            <th>Width</th>
            <th>Use In</th>
            <th class="text-end">Quantity Used</th>
            <th class="text-end">Stock</th>
            <th class="text-end">Cost / Unit</th>
            <th>Vendor</th>
            <th class="text-end">Rate</th>
            {% if can_edit or can_delete %}
              <th class="text-center">Actions</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% for p in printeds %}
            <tr>
              <td>{{ p.product }}</td>
              <td>{% if p.fabric %}{{ p.fabric.item_name }}{% else %}-{% endif %}</td>

              {# Quality: prefer Printed.quality, fallback to Fabric.quality #}
              <td>
                {% if p.quality is not None %}
                  {{ p.quality|floatformat:2 }}
                {% else %}
                  {% if p.fabric and p.fabric.quality is not None %}
                    {{ p.fabric.quality|floatformat:2 }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td>
                {% if p.base_color %}
                  {{ p.base_color }}
                {% else %}
                  {% if p.fabric and p.fabric.base_color %}
                    {{ p.fabric.base_color }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td>
                {% if p.product_type %}
                  {{ p.product_type }}
                {% else %}
                  {% if p.fabric and p.fabric.type %}
                    {{ p.fabric.type }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td class="text-nowrap">
                {% if p.width is not None %}
                  {{ p.width|floatformat:2 }}
                {% else %}
                  {% if p.fabric and p.fabric.fabric_width is not None %}
                    {{ p.fabric.fabric_width|floatformat:2 }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td>
                {% if p.use_in %}
                  {{ p.use_in }}
                {% else %}
                  {% if p.fabric and p.fabric.use_in %}
                    {{ p.fabric.use_in }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td class="text-end">{{ p.quantity_used|default_if_none:0|floatformat:3 }}</td>
              <td class="text-end">{{ p.stock|default_if_none:0|floatformat:3 }}</td>

              <td class="text-end">
                {% if p.cost_per_unit %}
                  {{ p.cost_per_unit|floatformat:2 }}
                {% else %}
                  {% if p.fabric and p.fabric.cost_per_unit %}
                    {{ p.fabric.cost_per_unit|floatformat:2 }}
                  {% else %}
                    0.00
                  {% endif %}
                {% endif %}
              </td>

              <td>
                {% if p.vendor %}
                  {{ p.vendor.vendor_name }}
                {% else %}
                  {% if p.fabric and p.fabric.vendor %}
                    {{ p.fabric.vendor.vendor_name }}
                  {% else %}
                    -
                  {% endif %}
                {% endif %}
              </td>

              <td class="text-end">{{ p.rate|default_if_none:0|floatformat:2 }}</td>

              {% if can_edit or can_delete %}
                <td class="text-center">
                  {% if can_edit %}
                    <a class="btn btn-sm btn-primary" href="{% url 'rawmaterials:printed_edit' p.pk %}">Edit</a>
                  {% endif %}

                  {% if can_delete %}
                    <form method="post"
                          action="{% url 'rawmaterials:inventory_delete' p.pk %}"
                          class="d-inline ms-1">
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="btn btn-sm btn-danger"
                        onclick="return confirm('Are you sure you want to permanently delete this printed product?');">
                        Delete
                      </button>
                    </form>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{% if can_edit or can_delete %}13{% else %}12{% endif %}" class="text-center text-muted py-3">
                No printed items found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
