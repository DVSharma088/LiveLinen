{% extends "base.html" %}
{% block page_title %}Dispatch Tracking{% endblock %}
{% block content %}
<h2>Dispatch Tracking</h2>

<div class="mb-3 d-flex justify-content-between align-items-center">
  <div>
    <form method="get" class="d-flex" style="gap:.5rem;">
      <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="Search order id / tracking # / courier">
      <select name="status" class="form-select form-select-sm">
        <option value="">All statuses</option>
        <option value="ready" {% if status_filter == 'ready' %}selected{% endif %}>Ready</option>
        <option value="dispatched" {% if status_filter == 'dispatched' %}selected{% endif %}>Dispatched</option>
        <option value="delivered" {% if status_filter == 'delivered' %}selected{% endif %}>Delivered</option>
      </select>
      <button class="btn btn-sm btn-primary" type="submit">Filter</button>
    </form>
  </div>

  <div>
    <small class="text-muted">Showing <strong>{{ dispatches.start_index }}–{{ dispatches.end_index }}</strong> of <strong>{{ total_count }}</strong></small>
  </div>
</div>

<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>#</th>
      <th>Work Order</th>
      <th>Variant</th>
      <th>Order Value</th>
      <th>Dispatch Date</th>
      <th>Courier</th>
      <th>Tracking #</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for d in dispatches %}
      <tr>
        <td>{{ d.pk }}</td>
        <td>
          {% if d.work_order.order_id %}{{ d.work_order.order_id }}{% else %}WO #{{ d.work_order.pk }}{% endif %}
        </td>
        <td>
          {% if d.variant %}{{ d.variant }}
          {% elif d.work_order.variant_ordered %}{{ d.work_order.variant_ordered }}
          {% else %}<em>—</em>{% endif %}
        </td>
        <td>
          {% if d.order_value %}{{ d.order_value }}
          {% elif d.work_order.order_value %}{{ d.work_order.order_value }}
          {% else %}<em>—</em>{% endif %}
        </td>
        <td>{{ d.dispatch_date|default:"—" }}</td>
        <td>{{ d.courier_company|default:"—" }}</td>
        <td>{{ d.tracking_number|default:"—" }}</td>
        <td>{{ d.get_status_display }}</td>
        <td>
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'dispatch:detail' d.pk %}">View</a>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="text-center text-muted">No dispatch records found.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<nav aria-label="Page navigation">
  <ul class="pagination pagination-sm">
    {% if dispatches.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ dispatches.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for p in dispatches.paginator.page_range %}
      {% if p >= dispatches.number|add:'-3' and p <= dispatches.number|add:'3' %}
        <li class="page-item {% if p == dispatches.number %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ p }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if dispatches.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ dispatches.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

{% endblock %}
