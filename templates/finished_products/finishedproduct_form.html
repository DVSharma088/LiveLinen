{% extends "base.html" %}
{% load static %}
{% block title %}New Finished Product{% endblock %}

{% block content %}
<div class="container py-4">
  <h1>Create Finished Product</h1>

  <form method="post" id="fp-form">
    {% csrf_token %}
    <div class="mb-3">
      {{ form.non_field_errors }}
      <label class="form-label">Product Name</label>
      {{ form.name }}
    </div>

    <div class="mb-3">
      <label class="form-label">Product Type</label>
      {{ form.product_type }}
    </div>

    <div class="mb-3">
      <label class="form-label">Collection</label>
      {{ form.fabric_collection }}
    </div>

    <div class="mb-3">
      <label class="form-label">Color</label>
      {{ form.fabric_color_name }}
    </div>

    {# SKU live preview (NEW pattern) #}
    <div class="mb-3">
      <label class="form-label">Product Code / SKU (preview)</label>
      <input type="text" id="sku-preview" class="form-control" readonly aria-readonly="true" value="">
      <small class="form-text text-muted">SKU is auto-generated on save (live preview updates below).</small>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">Size</label>
        {{ form.size }}
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Average</label>
        {{ form.average }}
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Product Price</label>
        {{ form.product_price }}
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Fabric Quality</label>
        {{ form.fabric_quality }}
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Fabric Width</label>
        {{ form.fabric_width }}
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Product Category</label>
        {{ form.product_category }}
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Fabric Pattern</label>
        {{ form.fabric_pattern }}
      </div>
    </div>

    <hr>

    <h4>Components / Raw Materials</h4>

    {{ line_formset.management_form }}

    <table class="table" id="components-table">
      <thead>
        <tr>
          <th style="min-width:200px;">Material Type</th>
          <th style="min-width:300px;">Material Item</th>
          <th style="width:180px;">Qty per unit</th>
          <th style="width:120px;">Line Cost</th>
          <th style="width:80px;"></th>
        </tr>
      </thead>
      <tbody id="components-body">
        {% for f in line_formset.forms %}
        <tr data-form-index="{{ forloop.counter0 }}">
          <td>{{ f.content_type.errors }}{{ f.content_type }}</td>
          <td>{{ f.object_id.errors }}{{ f.object_id }}</td>
          <td>{{ f.qty_per_unit.errors }}{{ f.qty_per_unit }}</td>
          <td class="line-cost-cell text-end"><span class="line-cost">â‚¹ 0.00</span></td>
          <td class="text-center">
            {% if f.instance.pk %}
            <input type="checkbox" name="{{ f.prefix }}-DELETE" id="id_{{ f.prefix }}-DELETE"> Delete
            {% else %}
            <button type="button" class="btn btn-sm btn-danger remove-row">Remove</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mb-3">
      <button type="button" class="btn btn-outline-primary" id="add-row">+ Add component</button>
    </div>

    <div class="mt-2">
      <strong>Total Manufacturing Cost (preview):</strong>
      <span id="total-cost">â‚¹ 0.00</span>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-success">Save Finished Product</button>
      <a href="{% url 'finished_products:product_list' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

{# Hidden prototype row #}
<table style="display:none;">
  <tbody id="empty-form-template">
    <tr data-empty="true">
      <td>{{ line_formset.empty_form.content_type }}</td>
      <td>{{ line_formset.empty_form.object_id }}</td>
      <td>{{ line_formset.empty_form.qty_per_unit }}</td>
      <td class="line-cost-cell text-end"><span class="line-cost">â‚¹ 0.00</span></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
    </tr>
  </tbody>
</table>

{# ðŸ’¡ New SKU Preview Script (server-based live generation) #}
<script>
(function () {
  const skuUrl = "{{ sku_preview_url|escapejs }}";

  function getVal(name) {
    const el = document.querySelector('[name="' + name + '"]');
    return el ? el.value : "";
  }

  let debounce;
  function updateSku() {
    clearTimeout(debounce);
    debounce = setTimeout(async function () {
      const params = new URLSearchParams({
        product_type: getVal("product_type"),
        fabric_collection: getVal("fabric_collection"),
        name: getVal("name"),
        fabric_color_name: getVal("fabric_color_name"),
        size: getVal("size"),
      });
      try {
        const resp = await fetch(skuUrl + "?" + params.toString(), { credentials: "same-origin" });
        if (!resp.ok) throw new Error("Network error");
        const data = await resp.json();
        const preview = document.getElementById("sku-preview");
        if (preview) preview.value = (data.sku || "").toUpperCase();
      } catch (err) {
        console.warn("SKU preview failed", err);
      }
    }, 250);
  }

  ["product_type", "fabric_collection", "name", "fabric_color_name", "size"].forEach(fname => {
    const el = document.querySelector('[name="' + fname + '"]');
    if (el) {
      el.addEventListener("change", updateSku);
      el.addEventListener("input", updateSku);
    }
  });

  document.addEventListener("DOMContentLoaded", updateSku);
})();
</script>

{# Existing materials JS (unchanged) #}
<script>
  // (keep your existing materials / line formset JS exactly as is)
</script>

{% endblock %}
