{% extends "base.html" %}
{% load static %}

{% block title %}Issue Material — Create{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm mx-auto" style="max-width:980px;">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Issue Material — Add multiple lines</h5>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'issue_material:issue_list' %}">Back</a>
    </div>

    <div class="card-body">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form id="multiIssueForm" method="post" action="{% url 'issue_material:create_issue' %}">
        {% csrf_token %}
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="name" class="form-label">Name</label>
            <input id="name" name="name" type="text" class="form-control" placeholder="Enter name (product/title)" />
          </div>
          <div class="col-md-6">
            <label for="order_no" class="form-label">Order No</label>
            <input id="order_no" name="order_no" type="text" class="form-control" placeholder="Enter order number (optional)" />
          </div>
        </div>

        <div class="mb-2 d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Lines</h6>
          <button id="addLineBtn" type="button" class="btn btn-sm btn-outline-primary">+ Add line</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered" id="linesTable">
            <thead>
              <tr>
                <th style="width:160px">Inventory Type</th>
                <th>Item (name)</th>
                <th style="width:110px">Qty</th>
                <th style="width:120px">From Waste</th>
                <th style="width:90px"></th>
              </tr>
            </thead>
            <tbody id="linesTbody">
              <!-- initial single row -->
              <tr class="line-row">
                <td>
                  <select name="inventory_type" class="form-select inventory-type-select" required>
                    <option value="">-- select type --</option>
                    <option value="accessory">Accessory</option>
                    <option value="fabric">Fabric</option>
                    <option value="printed">Printed</option>
                  </select>
                </td>
                <td>
                  <select name="item_id" class="form-select item-select" required>
                    <option value="">-- choose an item --</option>
                  </select>
                </td>
                <td>
                  <input name="qty" class="form-control qty-input" type="number" min="0" step="0.01" value="1" required />
                </td>
                <td class="text-center align-middle">
                  <!-- Hidden input (this will be the *only* posted field named 'from_waste' per-row).
                       JS will set its value to "1" when the checkbox is checked, otherwise "0". -->
                  <input type="hidden" name="from_waste" value="0" class="from-waste-hidden" />
                  <div class="form-check d-inline-block">
                    <!-- checkbox name is intentionally different; it is not posted directly.
                         JS reads it and updates the hidden input. -->
                    <input class="form-check-input from-waste-checkbox" name="from_waste_checkbox" type="checkbox" value="1" id="fromWaste0" />
                    <label class="form-check-label small" for="fromWaste0">From waste</label>
                  </div>
                </td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Create Issue</button>
          <a class="btn btn-outline-secondary" href="{% url 'issue_material:issue_list' %}">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function () {
  "use strict";
  const addLineBtn = document.getElementById("addLineBtn");
  const linesTbody = document.getElementById("linesTbody");
  const form = document.getElementById("multiIssueForm");
  let rowCounter = 1; // used to create unique IDs for checkbox labels

  function log() { if (window.console) console.log.apply(console, ["[issue_form]"].concat(Array.from(arguments))); }
  function warn() { if (window.console) console.warn.apply(console, ["[issue_form]"].concat(Array.from(arguments))); }

  // Row template: we'll clone this when adding rows
  function makeRow() {
    const idx = rowCounter++;
    const tr = document.createElement("tr");
    tr.className = "line-row";
    tr.innerHTML = `
      <td>
        <select name="inventory_type" class="form-select inventory-type-select" required>
          <option value="">-- select type --</option>
          <option value="accessory">Accessory</option>
          <option value="fabric">Fabric</option>
          <option value="printed">Printed</option>
        </select>
      </td>
      <td>
        <select name="item_id" class="form-select item-select" required>
          <option value="">-- choose an item --</option>
        </select>
      </td>
      <td>
        <input name="qty" class="form-control qty-input" type="number" min="0" step="0.01" value="1" required />
      </td>
      <td class="text-center align-middle">
        <input type="hidden" name="from_waste" value="0" class="from-waste-hidden" />
        <div class="form-check d-inline-block">
          <input class="form-check-input from-waste-checkbox" name="from_waste_checkbox" type="checkbox" value="1" id="fromWaste${idx}" />
          <label class="form-check-label small" for="fromWaste${idx}">From waste</label>
        </div>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">Remove</button>
      </td>
    `;
    return tr;
  }

  // Populate a given item-select element with results array [{id,name,stock}, ...]
  function populateItemSelect(itemSelectEl, results) {
    itemSelectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "-- choose an item --";
    itemSelectEl.appendChild(placeholder);
    if (!results || !results.length) {
      const opt = document.createElement("option"); opt.value=""; opt.textContent="(no items found)"; itemSelectEl.appendChild(opt);
      return;
    }
    results.forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.id || "";
      opt.textContent = it.name + (it.stock ? ` (stock: ${it.stock})` : "");
      itemSelectEl.appendChild(opt);
    });
  }

  // Fetch items for an inventory type (AJAX)
  async function fetchItemsFor(type) {
    if (!type) return [];
    const url = "/issue-material/ajax/items-by-type/?inventory_type=" + encodeURIComponent(type);
    try {
      const res = await fetch(url, { credentials: "same-origin" });
      if (!res.ok) {
        warn("AJAX failed", res.status, res.statusText);
        return [];
      }
      const json = await res.json();
      return json.results || [];
    } catch (err) {
      warn("AJAX error", err);
      return [];
    }
  }

  // When an inventory-type select changes, populate the item select in same row
  async function handleTypeChange(ev) {
    const sel = ev.target;
    const tr = sel.closest("tr");
    if (!tr) return;
    const itemSelect = tr.querySelector(".item-select");
    if (!itemSelect) return;
    const type = (sel.value || "").trim();
    if (!type) {
      itemSelect.innerHTML = '<option value="">-- choose an item --</option>';
      return;
    }
    const items = await fetchItemsFor(type);
    populateItemSelect(itemSelect, items);
  }

  // Toggle row visual when from-waste checkbox changes
  function handleFromWasteToggle(ev) {
    const chk = ev.target;
    const tr = chk.closest("tr");
    if (!tr) return;
    if (chk.checked) {
      tr.classList.add("table-warning");
    } else {
      tr.classList.remove("table-warning");
    }
  }

  // Attach events for a row (type change + remove + from_waste toggle)
  function wireRow(tr) {
    const typeSel = tr.querySelector(".inventory-type-select");
    const itemSel = tr.querySelector(".item-select");
    const removeBtn = tr.querySelector(".remove-line-btn");
    const fwChk = tr.querySelector(".from-waste-checkbox");

    if (typeSel) {
      typeSel.addEventListener("change", handleTypeChange);
    }
    if (fwChk) {
      fwChk.addEventListener("change", handleFromWasteToggle);
    }
    if (removeBtn) {
      removeBtn.addEventListener("click", function (e) {
        e.preventDefault();
        // If only one row remains, clear fields instead of removing
        const rows = linesTbody.querySelectorAll(".line-row");
        if (rows.length <= 1) {
          // clear values
          tr.querySelectorAll("select, input").forEach(el => {
            if (el.tagName === "SELECT") el.selectedIndex = 0;
            else if (el.tagName === "INPUT") {
              if (el.name === "qty") el.value = "1";
              else if (el.type === "checkbox") el.checked = false;
              else el.value = "";
            }
          });
          tr.classList.remove("table-warning");
        } else {
          tr.remove();
        }
      });
    }
  }

  // Before submit: ensure exactly one 'from_waste' value per row by writing the hidden inputs
  function syncFromWasteHiddenInputs() {
    linesTbody.querySelectorAll(".line-row").forEach(tr => {
      const hidden = tr.querySelector(".from-waste-hidden");
      const chk = tr.querySelector(".from-waste-checkbox");
      if (!hidden) return;
      hidden.value = (chk && chk.checked) ? "1" : "0";
    });
  }

  // Initialize existing rows on page load
  document.addEventListener("DOMContentLoaded", function () {
    // wire existing rows
    linesTbody.querySelectorAll(".line-row").forEach(wireRow);

    // if the first row has preselected type, populate its items
    const firstType = linesTbody.querySelector(".inventory-type-select");
    if (firstType && firstType.value) {
      firstType.dispatchEvent(new Event('change'));
    }
  });

  // Add line button
  addLineBtn.addEventListener("click", function (e) {
    e.preventDefault();
    const newRow = makeRow();
    linesTbody.appendChild(newRow);
    wireRow(newRow);
    // focus first control
    const firstSel = newRow.querySelector(".inventory-type-select");
    if (firstSel) firstSel.focus();
  });

  // Hook form submit to synchronise hidden inputs before sending
  if (form) {
    form.addEventListener("submit", function (e) {
      // sync before submit
      syncFromWasteHiddenInputs();
      // allow submit to proceed
    });
  }

})();
</script>

{% endblock %}
